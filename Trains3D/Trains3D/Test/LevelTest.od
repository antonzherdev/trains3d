package com.antonzherdev.trains

import com.antonzherdev.test._
import com.antonzherdev.test.Assert._


class LevelTest extends TestCase {
    def testLock {
        repeat(10) {
            val level : Level = LevelFactory.levelWith(mapSize = vec2i(5, 5))
            val railroad : Railroad = level.railroad
            val r0 = Rail(vec2i(0, 0), RailForm.leftRight)
            railroad.tryAdd(r0)
            val r1 = Rail(vec2i(1, 0), RailForm.leftRight)
            railroad.tryAdd(r1)
            railroad.tryAdd(Rail(vec2i(2, 0), RailForm.leftRight))
            railroad.tryAdd(Rail(vec2i(3, 0), RailForm.leftRight))
            railroad.tryAdd(Rail(vec2i(1, 0), RailForm.leftBottom))

            assertEquals(railroad.state.getResult(1).switches.count, 1)
            var sw = railroad.state.getResult(1).switches.head
            assertEquals(sw.switch.rail1.tile, vec2i(1, 0))
            assertEquals(sw.switch.rail1.form, RailForm.leftRight)
            assertTrue(sw.firstActive)

            val train = Train(level, TrainType.simple, CityColor.grey, [CarType.engine], 30)
            level.testRun(train, fromPoint = RailPoint(tile = vec2i(1, 0), RailForm.leftRight, x = 0, back = false))
            level.tryTurn(sw.switch)
            Thread.sleep(0.1)
            sw = railroad.state.getResult(1).switches.head
            assertTrue(sw.firstActive)
            assertTrue(level.isLocked(rail = r0).waitResult(1).get.get)

            train.set(head = RailPoint(tile = vec2i(3, 0), RailForm.leftRight, x = 0, back = false))
            level.tryTurn(sw.switch)
            Thread.sleep(0.1)
            sw = railroad.state.getResult(1).switches.head
            assertFalse(sw.firstActive)
            assertFalse(level.isLocked(rail = r0).waitResult(1).get.get)
        }
    }
}