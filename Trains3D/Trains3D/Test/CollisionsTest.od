package com.antonzherdev.trains

import com.antonzherdev.eg._
import com.antonzherdev.test._

class CollisionsTest extends TestCase {
    static val carLen = CarType.car.fullLength
    static val carWidth = CarType.car.width
    static val carConLen = CarType.car.startToFront
    def newLevel = Level(LevelRules(vec2i(5, 3), LevelFactory.scoreRules, 30, []))


    def check(level : Level) : Set<Train> = level.detectCollisions.chain.flatMap(_.cars).map(_.train).toSet

    def testStraight {
        val level = newLevel
        level.railroad.tryAdd(Rail(vec2i(0, 0), RailForm.leftRight))
        level.railroad.tryAdd(Rail(vec2i(1, 0), RailForm.leftRight))
        level.railroad.tryAdd(Rail(vec2i(2, 0), RailForm.leftRight))
        doTest1For(level, RailForm.leftRight)
    }

    def doTest1For(level : Level, form : RailForm) {
        val t1 = Train(level, TrainType.simple, CityColor.green, [Car(_, CarType.car)], 0)
        val p = RailPoint(vec2i(0, 0), form, 0, false)
        var p2 = level.railroad.moveWith(false, carLen, p).point
        level.testRun(t1, p2)

        val t2 = Train(level, TrainType.simple, CityColor.orange, [Car(_, CarType.car), Car(_, CarType.car)], 0)
        p2 = level.railroad.moveWith(false, carLen*3, p).point
        level.testRun(t2, p2)
        var cols = check(level)
        assertTrue(cols.isEmpty)

        p2 = p2.add(-2*carConLen + 0.1)
        t2.set(head = p2)
        cols = check(level)
        assertTrue(cols.isEmpty)

        p2 = p2.add(-0.2)
        t2.set(head = p2)
        cols = check(level)
        assertEquals(cols, [t1, t2].toSet)

        assertEquals(level.trains.count, 2)
        assertEquals(level.railroad.damagesPoints.count, 0)
        level.processCollisions
        assertEquals(level.trains.count, 0)
        assertEquals(level.railroad.damagesPoints.count, 1)
        val damage = level.railroad.damagesPoints[0]
        val l = carLen - CarType.car.startToWheel
        assertTrue(damage.x.between(l - 0.15, l + 0.15))
    }

    def testTurn {
        val level = newLevel
        level.railroad.tryAdd(Rail(vec2i(0, 0), RailForm.leftTop))
        level.railroad.tryAdd(Rail(vec2i(0, 1), RailForm.bottomRight))
        level.railroad.tryAdd(Rail(vec2i(1, 1), RailForm.leftRight))
        level.railroad.tryAdd(Rail(vec2i(2, 1), RailForm.leftRight))
        doTest1For(level, RailForm.leftTop)
    }

    def testCross {
        val level = newLevel
        level.railroad.tryAdd(Rail(vec2i(1, 1), RailForm.leftRight))
        level.railroad.tryAdd(Rail(vec2i(1, 1), RailForm.bottomTop))
        level.railroad.tryAdd(Rail(vec2i(2, 1), RailForm.leftRight))
        level.railroad.tryAdd(Rail(vec2i(3, 1), RailForm.leftRight))
        level.railroad.tryAdd(Rail(vec2i(1, 0), RailForm.bottomTop))

        val t1 = Train(level, TrainType.simple, CityColor.green, [Car(_, CarType.car)], 0)
        val p = RailPoint(vec2i(1, 1), RailForm.bottomTop, 0, false)
        val p1 = level.railroad.moveWith(false, 0.5 - carWidth - 0.001, p).point
        level.testRun(t1, p1)

        val t2 = Train(level, TrainType.simple, CityColor.orange, [Car(_, CarType.car), Car(_, CarType.car)], 0)
        p = RailPoint(vec2i(1, 1), RailForm.leftRight, 0, false)
        val p2 = level.railroad.moveWith(false, carLen*2, p).point
        level.testRun(t2, p2)
        var cols = check(level)
        assertTrue(cols.isEmpty)

        t1.set(head = p2.add(-0.002))
        cols = check(level)
        assertEquals(cols, [t1, t2].toSet)
    }
}